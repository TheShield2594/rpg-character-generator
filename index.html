<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lorebound v3.0 — NPC Inspiration Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg0:#05070d;
  --bg1:#0b1021;
  --glass-bg: rgba(20, 25, 40, 0.6);
  --glass-border: rgba(255,255,255,0.15);
  --glass-highlight: rgba(255,255,255,0.05);
  --accent: #78aaff;
  --accent-glow: rgba(120,170,255,0.3);
  --success: #78ffdc;
  --danger: #ff5a82;
  --gold: #ffd700;
  --text: #e2e8f0;
  --muted: #94a3b8;
  --radius-xl: 24px;
  --radius-md: 12px;
  --font-head: 'Cinzel', serif;
  --font-body: 'Inter', sans-serif;
}

*{ box-sizing:border-box; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }

body{
  margin:0;
  font-family: var(--font-body);
  color: var(--text);
  min-height:100vh;
  background-color: var(--bg0);
  background-image: 
    radial-gradient(at 0% 0%, rgba(86, 68, 172, 0.15) 0px, transparent 50%),
    radial-gradient(at 100% 100%, rgba(55, 137, 164, 0.15) 0px, transparent 50%);
  display: flex;
  justify-content: center;
  padding: 20px;
}

/* Noise Texture Overlay */
body::before {
  content: "";
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
  pointer-events: none; z-index: -1;
}

.app{
  width: 100%; max-width: 1200px;
  display: grid; grid-template-columns: 1fr 340px;
  gap: 24px; align-items: start;
}

@media(max-width:900px){ .app{ grid-template-columns: 1fr; } }

/* Glass Components */
.glass {
  background: var(--glass-bg);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  overflow: hidden;
}

/* Typography Overrides */
h1, h2, h3, .bigName, .stat-val { font-family: var(--font-head); }

/* Header */
header { 
  padding: 24px 32px; 
  border-bottom: 1px solid var(--glass-border); 
  display: flex; justify-content: space-between; align-items: center; 
  background: linear-gradient(to right, rgba(255,255,255,0.02), transparent);
}
h1 { margin:0; font-size: 24px; color:white; display:flex; align-items:baseline; gap:10px; text-shadow: 0 0 20px rgba(120,170,255,0.5); }
.version { font-family: var(--font-body); font-size: 11px; background: var(--glass-border); padding: 2px 8px; border-radius: 12px; opacity: 0.8; }

/* Main Content Area */
.content { padding: 32px; display: flex; flex-direction: column; gap: 24px; }

/* Cards */
.card {
  background: rgba(0,0,0,0.2);
  padding: 24px;
  border-radius: var(--radius-md);
  border: 1px solid var(--glass-border);
  position: relative;
}
.card:hover { border-color: var(--accent); background: rgba(0,0,0,0.3); }

/* Profile Layout */
.profile-header { display: flex; gap: 24px; align-items: center; }
.avatar { 
  width: 100px; height: 100px; 
  background: #000; border-radius: 50%; 
  border: 2px solid var(--glass-border); 
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  flex-shrink: 0;
  overflow: hidden;
}
.avatar img { width: 100%; height: 100%; object-fit: cover; }

.bigName { 
  font-size: 38px; color: #fff; line-height: 1.1; margin-bottom: 8px;
  background: linear-gradient(180deg, #fff, #ccc);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

/* Controls */
.label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); font-weight: 700; opacity: 0.9; }
.reroll-mini { 
  background: transparent; border: 1px solid var(--glass-border); 
  color: var(--muted); cursor: pointer; padding: 4px 10px; 
  font-size: 11px; border-radius: 20px; 
}
.reroll-mini:hover { color: white; border-color: var(--accent); background: rgba(120,170,255,0.1); }

/* Stats */
.stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 16px; }
.stat-box { 
  background: rgba(255,255,255,0.03); border-radius: 12px; padding: 12px 8px; 
  text-align: center; border: 1px solid transparent; display:flex; flex-direction:column; gap:4px;
}
.stat-box.high { border-color: rgba(120,255,220,0.3); background: rgba(120,255,220,0.05); }
.stat-val { font-size: 24px; font-weight: 700; color: white; }
.stat-name { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; font-family: var(--font-body); }

/* Derived Stats (HP/AC) */
.derived-stats { display:flex; gap: 12px; margin-top: 12px; }
.derived-pill { 
  flex: 1; background: #000; border: 1px solid var(--glass-border); 
  padding: 8px; border-radius: 8px; display:flex; justify-content: space-between; align-items: center; 
  font-size: 13px; color: var(--muted);
}
.derived-val { color: white; font-weight: 700; }

/* Chips */
.chips { display: flex; gap: 8px; flex-wrap: wrap; }
.chip { 
  padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 500; 
  border: 1px solid var(--glass-border); background: rgba(255,255,255,0.03);
}
.chip.virtue { border-color: rgba(120, 255, 220, 0.4); color: var(--success); }
.chip.vice { border-color: rgba(255, 90, 130, 0.4); color: var(--danger); }
.chip.gold { border-color: rgba(255, 215, 0, 0.4); color: var(--gold); }

/* Secret */
.secret-container {
  background: repeating-linear-gradient(45deg, rgba(0,0,0,0.2), rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.3) 10px, rgba(0,0,0,0.3) 20px);
  padding: 16px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px dashed var(--glass-border);
}
.secret-container.revealed { background: rgba(0,0,0,0.4); border-style: solid; text-align: left;}
.secret-text { filter: blur(8px); opacity: 0.7; transition: 0.5s; }
.revealed .secret-text { filter: blur(0); opacity: 1; color: var(--danger); font-weight: 600; }
.secret-hint { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; margin-top: 8px; color: var(--muted); }
.revealed .secret-hint { display: none; }

/* Sidebar */
.sidebar { padding: 24px; display: flex; flex-direction: column; gap: 16px; height: fit-content; position: sticky; top: 20px; }
input, textarea {
  background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border); 
  color: white; padding: 12px; border-radius: var(--radius-md); 
  font-family: var(--font-body); width: 100%;
}
select {
  background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
  color: white; padding: 12px; border-radius: var(--radius-md);
  font-family: var(--font-body); width: 100%;
}
input:focus, textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }

/* Buttons */
button.btn-main {
  cursor: pointer; border: none; 
  background: var(--accent); color: var(--bg0); 
  padding: 12px 20px; border-radius: var(--radius-md); 
  font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px;
  font-family: var(--font-body); text-transform: uppercase; font-size: 12px; letter-spacing: 1px;
}
button.btn-main:hover { filter: brightness(1.2); box-shadow: 0 0 20px var(--accent-glow); }
button.btn-sec { 
  background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--glass-border); 
}
button.btn-sec:hover { background: rgba(255,255,255,0.1); }

.saved-list { max-height: 400px; overflow-y: auto; padding-right: 4px; }
/* Scrollbar styling */
.saved-list::-webkit-scrollbar { width: 6px; }
.saved-list::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }
.saved-item { 
  padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; 
  font-size: 13px; display: flex; justify-content: space-between; align-items: center;
  border-left: 2px solid transparent;
}
.saved-item:hover { background: rgba(255,255,255,0.06); border-left-color: var(--accent); }

.party-members { display: flex; flex-direction: column; gap: 8px; max-height: 260px; overflow-y: auto; padding-right: 4px; }
.party-member { 
  display: grid; grid-template-columns: 1.2fr 0.9fr 1fr auto; gap: 8px; align-items: center;
  background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px; border: 1px solid var(--glass-border);
}
.party-member input, .party-member select { padding: 8px; font-size: 12px; }
.party-member .member-name { font-size: 12px; color: var(--text); font-weight: 600; }
.party-meta { display: grid; gap: 8px; }
.party-meta textarea { resize: vertical; min-height: 60px; }
.party-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.toast{ 
  position:fixed; bottom:30px; left:50%; transform:translateX(-50%) translateY(20px); 
  background: white; color: var(--bg0); font-weight: 700; padding:12px 30px; border-radius:40px; 
  opacity:0; pointer-events:none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 999;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>

<body>

<div class="app">
  <section class="glass main">
    <header>
      <div>
        <h1>⚔️ Lorebound Inspiration <span class="version">v3.0</span></h1>
        <div style="font-size: 13px; color: var(--muted); margin-top: 4px;">Procedural NPC Idea Engine</div>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn-main btn-sec" id="copyMdBtn">MD</button>
        <button class="btn-main btn-sec" id="copyBtn">JSON</button>
        <button class="btn-main" id="rerollBtn">Reroll All</button>
      </div>
    </header>

    <div class="content" id="character">
      </div>
  </section>

  <aside class="glass sidebar">
    <div class="label">Library</div>
    <div style="display:flex; gap:8px;">
      <input id="saveTitle" placeholder="Character Label..." />
      <button class="btn-main" id="saveBtn" style="padding:0 16px;">Save</button>
    </div>
    
    <div id="saves" class="saved-list"></div>
    
    <hr style="width:100%; border:0; border-top:1px solid var(--glass-border); margin:4px 0;">
    
    <div class="label">Data Management</div>
    <textarea id="importBox" rows="3" placeholder="Paste JSON string..."></textarea>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
      <button class="btn-main btn-sec" id="importBtn">Import</button>
      <button class="btn-main btn-sec" id="clearBtn" style="color:var(--danger); border-color:rgba(255,90,130,0.3)">Reset</button>
    </div>

    <hr style="width:100%; border:0; border-top:1px solid var(--glass-border); margin:4px 0;">

    <div class="label">Campaign Companion</div>
    <div class="party-meta">
      <select id="partySelect"></select>
      <input id="partyName" placeholder="Party Name..." />
      <textarea id="partySetting" rows="2" placeholder="Campaign setting..."></textarea>
      <textarea id="partyFactions" rows="2" placeholder="Factions or rivals..."></textarea>
      <textarea id="partyLocations" rows="2" placeholder="Key locations..."></textarea>
      <textarea id="partyNotes" rows="2" placeholder="GM notes / session notes..."></textarea>
      <div class="party-controls">
        <button class="btn-main btn-sec" id="newPartyBtn">New Party</button>
        <button class="btn-main" id="savePartyBtn">Save Party</button>
      </div>
      <button class="btn-main btn-sec" id="addToPartyBtn">Add Current to Party</button>
    </div>

    <div class="label" style="margin-top:8px;">Party Roster</div>
    <div id="partyMembers" class="party-members"></div>
    <div class="party-controls" style="margin-top:8px;">
      <button class="btn-main btn-sec" id="exportPartyMdBtn">Export Party MD</button>
      <button class="btn-main btn-sec" id="exportPartyPdfBtn">Export Party PDF</button>
    </div>
  </aside>
</div>

<div class="toast" id="toast"></div>

<script>
// --- EXTENDED DATA SET ---
const data = {
  names: [
    "Aelric", "Bram", "Cia", "Dax", "Elion", "Faelan", "Gorm", "Hestia", "Iris", "Jax", "Kael", "Lysa", "Maren", "Nyx", "Orin", "Prynne", "Quinn", "Rael", "Sia", "Torin", "Ulva", "Vane", "Wyla", "Xan", "Yori", "Zane",
    "Aurelius", "Beatrix", "Cassian", "Desdemona", "Evander", "Fenwick", "Ginevra", "Hadrian", "Isadora", "Julius", "Killian", "Leander", "Magnolia", "Nathaniel", "Octavia", "Phineas", "Quill", "Rosalind", "Silas", "Thaddeus", "Uriah", "Valerius", "Winifred", "Xavier", "Yvaine", "Zephyr",
    "Artemis", "Bjorn", "Calliope", "Dante", "Elowen", "Freya", "Gideon", "Helios", "Indra", "Juno", "Kratos", "Loki", "Morrigan", "Nero", "Odin", "Persephone", "Qadir", "Ragnar", "Selene", "Thor", "Ulysses", "Valkyrie", "Wolf", "Xena", "Yara", "Zeus",
    "Ash", "Brook", "Clay", "Dale", "Ember", "Flint", "Glen", "Heath", "Ivy", "Jasper", "Kestrel", "Lark", "Moss", "North", "Oak", "Pine", "Quartz", "Reed", "Sage", "Thorn", "Umber", "Vine", "Willow", "Xylia", "Yarrow", "Zinnia"
  ],
  epithets: [
    "the Unbroken", "the Star-Eyed", "the Silent", "the Oath-Keeper", "the Storm-Bringer", "the Void-Walker", 
    "the Iron-Willed", "the Silver-Tongued", "the Shadow-Weaver", "the Light-Bringer", "the Dream-Chaser", 
    "the Soul-Eater", "the Fate-Spinner", "the Time-Bender", "the World-Breaker", "the Hope-Bringer", 
    "of the Hidden Path", "of the Frozen Wastes", "of the Burning Sands", "of the Whispering Woods", 
    "of the Sunken City", "of the High Heavens", "of the Deep Hells", "the Kinslayer", "the Peacekeeper",
    "the Last Sentinel", "the Gilded Hand", "the Twice-Orphaned", "the Grave-Digger", "the Copper-Heart"
  ],
  ancestries: [
    "Human (Imperial)", "Human (Nomad)", "Human (Urban)", "High Elf", "Wood Elf", "Dark Elf (Drow)", "Sea Elf", 
    "Mountain Dwarf", "Hill Dwarf", "Duergar", "Orc", "Half-Orc", "Goblin", "Hobgoblin", "Bugbear", 
    "Halfling (Stout)", "Halfling (Lightfoot)", "Gnome (Rock)", "Gnome (Forest)", "Deep Gnome", 
    "Dragonborn (Chromatic)", "Dragonborn (Metallic)", "Tiefling (Infernal)", "Tiefling (Abyssal)", "Aasimar", 
    "Genasi (Fire)", "Genasi (Water)", "Genasi (Earth)", "Genasi (Air)", "Goliath", "Firbolg", "Kenku", 
    "Aarakocra", "Tabaxi", "Triton", "Yuan-Ti", "Changeling", "Shifter", "Warforged", "Centaur", "Minotaur", 
    "Satyr", "Fairy", "Harengon", "Lizardfolk", "Kobold"
  ],
  jobs: [
    // WARRIORS (Might/Agility/Spirit)
    { title: "Sellsword", primary: ["might", "agility"] },
    { title: "Gladiator", primary: ["might", "spirit"] },
    { title: "Knight Errant", primary: ["might", "spirit"] },
    { title: "Bounty Hunter", primary: ["agility", "wits"] },
    { title: "City Watch", primary: ["might", "wits"] },
    { title: "Tribal Warrior", primary: ["might", "agility"] },
    { title: "Viking Raider", primary: ["might", "spirit"] },
    { title: "Samurai", primary: ["agility", "spirit"] },
    { title: "Temple Guardian", primary: ["might", "spirit"] },
    
    // ROGUES & EXPERTS (Agility/Wits)
    { title: "Master Thief", primary: ["agility", "wits"] },
    { title: "Assassin", primary: ["agility", "wits"] },
    { title: "Smuggler", primary: ["agility", "spirit"] },
    { title: "Spy", primary: ["wits", "agility"] },
    { title: "Scout", primary: ["agility", "wits"] },
    { title: "Pirate", primary: ["agility", "spirit"] },
    { title: "Dungeon Delver", primary: ["wits", "agility"] },
    { title: "Forgery Artist", primary: ["wits", "agility"] },
    
    // MAGES & SCHOLARS (Wits/Spirit)
    { title: "Archmage", primary: ["wits", "spirit"] },
    { title: "Necromancer", primary: ["wits", "spirit"] },
    { title: "Druid", primary: ["spirit", "wits"] },
    { title: "Alchemist", primary: ["wits", "agility"] },
    { title: "Archaeologist", primary: ["wits", "agility"] },
    { title: "Cult Leader", primary: ["spirit", "wits"] },
    { title: "Soothsayer", primary: ["spirit", "wits"] },
    { title: "Runesmith", primary: ["wits", "might"] },
    { title: "Battle Mage", primary: ["wits", "might"] },
    { title: "Exorcist", primary: ["spirit", "will"] },
    
    // SOCIAL & OTHERS
    { title: "Merchant Prince", primary: ["spirit", "wits"] },
    { title: "Bard", primary: ["spirit", "agility"] },
    { title: "Innkeeper", primary: ["spirit", "might"] },
    { title: "Ship Captain", primary: ["wits", "spirit"] },
    { title: "Politician", primary: ["spirit", "wits"] },
    { title: "Blacksmith", primary: ["might", "wits"] },
    { title: "Chef", primary: ["wits", "agility"] },
    { title: "Doctor", primary: ["wits", "spirit"] }
  ],
  traits: [
    "stoic", "cheerful", "grumpy", "anxious", "confident", "arrogant", "humble", "brave", "cowardly", "greedy", 
    "generous", "loyal", "treacherous", "honest", "deceitful", "curious", "indifferent", "passionate", "cold", 
    "logical", "emotional", "superstitious", "skeptical", "pious", "atheist", "elegant", "clumsy", "graceful", 
    "loud", "quiet", "charming", "rude", "witty", "dull", "optimistic", "pessimistic", "realistic", "dreamy", 
    "focused", "distracted", "clean", "dirty", "refined", "crude", "gentle", "rough", "forgiving", "vengeful"
  ],
  virtues: [
    "Justice", "Temperance", "Fortitude", "Prudence", "Faith", "Hope", "Charity", "Humility", "Patience", 
    "Kindness", "Diligence", "Chastity", "Integrity", "Honor", "Compassion", "Forgiveness", "Selflessness", 
    "Responsibility", "Respect", "Fairness", "Trustworthiness", "Loyalty", "Courage", "Wisdom", "Moderation"
  ],
  vices: [
    "Lust", "Gluttony", "Greed", "Sloth", "Wrath", "Envy", "Pride", "Vanity", "Avarice", "Cowardice", 
    "Deceit", "Treachery", "Cruelty", "Indifference", "Laziness", "Impatience", "Arrogance", "Selfishness", 
    "Dishonesty", "Disloyalty", "Recklessness", "Suspicion", "Jealousy", "Spite", "Malice"
  ],
  hooks: [
    "woke up in a morgue with a toe tag but no memory of dying",
    "has a key that glows when pointing north, but fits no lock",
    "is being followed by a stray cat that is definitely a polymorphed wizard",
    "owes a favor to a Fae Queen that must be repaid by the next full moon",
    "stole a map from a dead adventurer that leads to the 'World's End'",
    "hears the thoughts of people who are about to die",
    "cannot step on holy ground without their skin smoking",
    "is searching for their twin who was kidnapped by sky pirates",
    "has a shadow that moves independently of their body",
    "carries a jar containing the last breath of a dying god",
    "is convinced they are a character in a story being written by a madman",
    "must consume a gemstone every week or turn to stone",
    "is on the run from a marriage arrangement with a vampire lord",
    "accidentally released a demon and is trying to capture it before anyone knows",
    "has a bounty on their head for a crime they actually didn't commit... this time",
    "is the sole survivor of a village that vanished overnight",
    "wears a mask they can never take off",
    "is looking for the ingredients to brew a potion of immortality"
  ],
  secrets: [
    "They are actually a dragon in humanoid form, stuck this way.",
    "They killed the original hero and took their place.",
    "They are a time traveler from a bad future trying to fix it.",
    "They are unknowingly a sleeper agent for the main villain.",
    "They are dead and just a very strong ghost possessing a body.",
    "They are the illegitimate child of the King.",
    "They sold their firstborn for magical power.",
    "They are addicted to a potion that suppresses their true monstrous form.",
    "They know the location of a weapon that could destroy the world.",
    "They are actually three kobolds in a trench coat.",
    "They have a phylactery hidden somewhere, making them technically a lich.",
    "They are a construct (robot) who believes they are human.",
    "They are wanted in three kingdoms for 'regicide'.",
    "They are a fallen angel seeking a way back to grace.",
    "They are a spy for a rival dimension."
  ],
  items: [
    "Bag of Holding (full of sand)", "Immovable Rod", "Decanter of Endless Water", "Cloak of Billowing", 
    "Sending Stones", "Alchemy Jug", "Driftglobe", "Goggles of Night", "Hat of Disguise", "Lantern of Revealing", 
    "Rope of Climbing", "Wind Fan", "Winged Boots", "Broom of Flying", "Carpet of Flying", "Crystal Ball", 
    "Cube of Force", "Deck of Many Things (Missing the good cards)", "Figurine of Wondrous Power", "Gem of Seeing", 
    "Horn of Blasting", "Iron Bands of Binding", "Mirror of Life Trapping", "Pearl of Power", "Ring of Invisibility", 
    "Rod of Lordly Might", "Sphere of Annihilation (Tiny)", "Staff of Power", "Sword of Sharpness", "Vorpal Sword", 
    "Well of Many Worlds", "Apparatus of Kwalish", "Daern's Instant Fortress", "Mighty Servant of Leuk-o", 
    "Orrery of the Wanderer", "Ring of Winter", "Staff of the Forgotten One", "Stone of Golorr", "Wand of Orcus"
  ],
  weapons: [
    "Longsword", "Shortsword", "Greatsword", "Rapier", "Scimitar", "Dagger", "Handaxe", "Battleaxe", "Greataxe", 
    "Warhammer", "Maul", "Flail", "Morningstar", "War Pick", "Spear", "Lance", "Halberd", "Glaive", "Pike", 
    "Trident", "Quarterstaff", "Club", "Greatclub", "Mace", "Sickle", "Shortbow", "Longbow", "Light Crossbow", 
    "Heavy Crossbow", "Hand Crossbow", "Sling", "Dart", "Blowgun", "Net", "Whip"
  ]
};

// --- LOGIC ---
let current = {};
let saves = JSON.parse(localStorage.getItem('lorebound_saves') || '[]');
let parties = JSON.parse(localStorage.getItem('lorebound_parties') || '[]');
let activePartyId = null;

const makeId = () => {
  if (window.crypto && window.crypto.randomUUID) {
    return window.crypto.randomUUID();
  }
  return `id_${Date.now()}_${Math.random().toString(16).slice(2)}`;
};

const pick = a => a[Math.floor(Math.random()*a.length)];
const roll = (min, max) => Math.floor(Math.random() * (max - min + 1) + min);
const toast = t => { 
  const el=document.getElementById("toast"); el.textContent=t; 
  el.classList.add("show"); setTimeout(()=>el.classList.remove("show"),2500); 
};
const escapeHtml = (value = '') => String(value)
  .replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;")
  .replace(/"/g, "&quot;")
  .replace(/'/g, "&#039;");

// Logic: Weighted Stat Generation based on Job
const generateStats = (jobData) => {
  // Standard Array
  let pool = [16, 14, 13, 11, 10, 8];
  let stats = { might: 10, agility: 10, wits: 10, spirit: 10 };
  
  // Identify priority stats
  const primaries = jobData ? jobData.primary : [];
  const others = Object.keys(stats).filter(k => !primaries.includes(k));
  
  // Assign highest values to primary stats
  primaries.forEach(stat => {
    const valIndex = Math.floor(Math.random() * 2); // Pick one of top 2 remaining
    stats[stat] = pool.splice(valIndex, 1)[0];
  });
  
  // Randomize remainder
  others.forEach(stat => {
    const valIndex = Math.floor(Math.random() * pool.length);
    stats[stat] = pool.splice(valIndex, 1)[0];
  });

  return stats;
};

// Logic: Derived Stats
const calculateDerived = (stats) => {
  const hp = 10 + Math.floor((stats.might - 10) / 2) + Math.floor((stats.spirit - 10) / 2);
  const def = 10 + Math.floor((stats.agility - 10) / 2);
  return { hp, def };
};

function generate(field = 'all') {
  if (field === 'all' || field === 'name') {
    current.name = pick(data.names);
    current.epithet = pick(data.epithets);
  }
  
  if (field === 'all' || field === 'bio') {
    current.ancestry = pick(data.ancestries);
    current.jobObj = pick(data.jobs);
    current.job = current.jobObj.title; // Flatten for display
    current.trait = pick(data.traits);
  }
  
  // If we regenerate stats, we need the job object to weight them correctly
  if (field === 'all' || field === 'stats') {
    // If job is missing (partial reroll edge case), pick one temporarily or random
    const refJob = current.jobObj || pick(data.jobs); 
    current.stats = generateStats(refJob);
    current.derived = calculateDerived(current.stats);
  }

  if (field === 'all' || field === 'alignment') {
    current.virtue = pick(data.virtues);
    current.vice = pick(data.vices);
  }
  
  if (field === 'all' || field === 'inventory') {
    current.weapon = pick(data.weapons);
    current.item = pick(data.items);
  }

  if (field === 'all' || field === 'hook') {
    current.hook = pick(data.hooks);
    current.secret = pick(data.secrets);
  }
  
  render();
}

function render() {
  const seed = current.name + current.ancestry; // Consistent avatar seed
  const avatarUrl = `https://api.dicebear.com/9.x/adventurer/svg?seed=${seed}&backgroundColor=b6e3f4,c0aede,d1d4f9`;

  document.getElementById("character").innerHTML = `
    <div class="card">
      <div class="profile-header">
        <div class="avatar">
           <img src="${avatarUrl}" alt="Character Avatar">
        </div>
        <div style="flex:1">
          <div class="label-row" style="margin-bottom:4px;">
            <span class="label">Identity</span>
            <button class="reroll-mini" onclick="generate('name')">⟳ Name</button>
          </div>
          <div class="bigName">${current.name}</div>
          <div style="font-size:14px; opacity:0.8; font-style:italic; margin-bottom:8px;">${current.epithet}</div>
          <div class="sub" style="font-size: 15px;">
            A <strong>${current.trait}</strong> ${current.ancestry} <strong style="color:var(--accent)">${current.job}</strong>
          </div>
        </div>
      </div>

      <div class="label-row" style="margin-top:24px; margin-bottom:4px;">
        <span class="label">Attributes</span>
        <button class="reroll-mini" onclick="generate('stats')">⟳ Stats</button>
      </div>
      
      <div class="stat-grid">
        <div class="stat-box ${current.stats.might >= 15 ? 'high' : ''}">
          <span class="stat-val">${current.stats.might}</span><span class="stat-name">Might</span>
        </div>
        <div class="stat-box ${current.stats.agility >= 15 ? 'high' : ''}">
          <span class="stat-val">${current.stats.agility}</span><span class="stat-name">Agility</span>
        </div>
        <div class="stat-box ${current.stats.wits >= 15 ? 'high' : ''}">
          <span class="stat-val">${current.stats.wits}</span><span class="stat-name">Wits</span>
        </div>
        <div class="stat-box ${current.stats.spirit >= 15 ? 'high' : ''}">
          <span class="stat-val">${current.stats.spirit}</span><span class="stat-name">Spirit</span>
        </div>
      </div>
      
      <div class="derived-stats">
        <div class="derived-pill"><span>Health</span> <span class="derived-val">${current.derived.hp}</span></div>
        <div class="derived-pill"><span>Defense</span> <span class="derived-val">${current.derived.def}</span></div>
      </div>
    </div>

    <div class="card">
      <div class="label-row">
        <span class="label">Details</span>
        <div style="display:flex; gap:8px;">
          <button class="reroll-mini" onclick="generate('alignment')">⟳ Psyche</button>
          <button class="reroll-mini" onclick="generate('inventory')">⟳ Gear</button>
        </div>
      </div>
      <div class="chips">
        <div class="chip virtue">Virtue: ${current.virtue}</div>
        <div class="chip vice">Vice: ${current.vice}</div>
        <div class="chip gold">Weapon: ${current.weapon}</div>
        <div class="chip">Item: ${current.item}</div>
      </div>
    </div>

    <div class="card">
      <div class="label-row">
        <span class="label">Narrative</span>
        <button class="reroll-mini" onclick="generate('hook')">⟳ Plot</button>
      </div>
      <div style="line-height:1.6; font-size:15px; color:var(--text); margin-bottom:20px;">
        <strong>Hook:</strong> This character ${current.hook}.
      </div>
      
      <div class="secret-container" onclick="this.classList.toggle('revealed')">
        <span class="label" style="color:var(--danger); display:block; margin-bottom:8px;">Dark Secret</span>
        <div class="secret-text">${current.secret}</div>
        <div class="secret-hint">(Click to Reveal)</div>
      </div>
    </div>
  `;
  renderSaves();
  renderPartyPanel();
}

function renderSaves() {
  const container = document.getElementById("saves");
  container.innerHTML = saves.map((s, i) => `
    <div class="saved-item">
      <div style="overflow:hidden;">
        <div style="font-weight:700; color:var(--accent); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.saveTitle || s.name}</div>
        <div style="font-size:11px; color:var(--muted)">${s.ancestry} ${s.job}</div>
      </div>
      <div style="display:flex; gap:4px;">
        <button class="reroll-mini" onclick="loadSave(${i})">Load</button>
        <button class="reroll-mini" onclick="deleteSave(${i})" style="color:var(--danger); border-color:transparent;">✕</button>
      </div>
    </div>
  `).join('');
}

function hydrateSaves() {
  let changed = false;
  saves = saves.map(save => {
    if (!save.id) {
      changed = true;
      return { ...save, id: makeId() };
    }
    return save;
  });
  if (changed) {
    localStorage.setItem('lorebound_saves', JSON.stringify(saves));
  }
}

function renderPartyPanel() {
  const select = document.getElementById("partySelect");
  if (!select) return;
  const options = [`<option value="">Select a party...</option>`];
  parties.forEach(party => {
    const selected = party.id === activePartyId ? 'selected' : '';
    options.push(`<option value="${party.id}" ${selected}>${party.name || 'Unnamed Party'}</option>`);
  });
  select.innerHTML = options.join('');
  const activeParty = parties.find(p => p.id === activePartyId);
  if (!activeParty) {
    document.getElementById("partyName").value = '';
    document.getElementById("partySetting").value = '';
    document.getElementById("partyFactions").value = '';
    document.getElementById("partyLocations").value = '';
    document.getElementById("partyNotes").value = '';
  }
  renderPartyMembers(activeParty);
}

function renderPartyMembers(party) {
  const container = document.getElementById("partyMembers");
  if (!container) return;
  if (!party || !party.members || party.members.length === 0) {
    container.innerHTML = `<div style="font-size:12px; color:var(--muted);">No party members yet.</div>`;
    return;
  }
  const roles = getRoles();
  container.innerHTML = party.members.map(member => {
    const character = saves.find(save => save.id === member.id);
    if (!character) return '';
    const safeName = escapeHtml(character.saveTitle || character.name);
    const safeRelationship = escapeHtml(member.relationship || '');
    const safeMemberId = escapeHtml(member.id);
    const roleOptions = roles.map(role => {
      const selected = role === member.role ? 'selected' : '';
      const safeRole = escapeHtml(role);
      return `<option value="${safeRole}" ${selected}>${safeRole}</option>`;
    }).join('');
    return `
      <div class="party-member">
        <div class="member-name">${safeName}</div>
        <select data-member-role="${safeMemberId}">${roleOptions}</select>
        <input data-member-relationship="${safeMemberId}" placeholder="Relationship..." value="${safeRelationship}">
        <button class="reroll-mini" onclick="removePartyMember('${safeMemberId}')">✕</button>
      </div>
    `;
  }).join('');
  container.querySelectorAll('[data-member-role]').forEach(select => {
    select.onchange = () => updateMemberRole(select.dataset.memberRole, select.value);
  });
  container.querySelectorAll('[data-member-relationship]').forEach(input => {
    input.onchange = () => updateMemberRelationship(input.dataset.memberRelationship, input.value);
  });
}

function getRoles() {
  return ["Tank", "Healer", "Face", "Striker", "Support", "Controller", "Scout", "Utility", "Wild Card"];
}

function updateMemberRole(memberId, role) {
  const party = parties.find(p => p.id === activePartyId);
  if (!party) return;
  const member = party.members.find(m => m.id === memberId);
  if (member) {
    member.role = role;
    saveParties();
  }
}

function updateMemberRelationship(memberId, relationship) {
  const party = parties.find(p => p.id === activePartyId);
  if (!party) return;
  const member = party.members.find(m => m.id === memberId);
  if (member) {
    member.relationship = relationship;
    saveParties();
  }
}

function removePartyMember(memberId) {
  const party = parties.find(p => p.id === activePartyId);
  if (!party) return;
  party.members = party.members.filter(m => m.id !== memberId);
  saveParties();
  renderPartyMembers(party);
}

function saveParties() {
  localStorage.setItem('lorebound_parties', JSON.stringify(parties));
}

// --- CONTROLS ---
document.getElementById("saveBtn").onclick = () => {
  const title = document.getElementById("saveTitle").value;
  const id = current.id || makeId();
  current.id = id;
  const updatedSave = { ...current, saveTitle: title || current.name };
  const existingIndex = saves.findIndex(save => save.id === id);
  if (existingIndex >= 0) {
    saves[existingIndex] = updatedSave;
  } else {
    saves.unshift(updatedSave);
  }
  localStorage.setItem('lorebound_saves', JSON.stringify(saves));
  document.getElementById("saveTitle").value = '';
  renderSaves();
  toast("Character Archived");
};

document.getElementById("clearBtn").onclick = () => {
  if(confirm("Permanently delete all saved characters?")) {
    saves = [];
    localStorage.removeItem('lorebound_saves');
    renderSaves();
  }
};

document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(JSON.stringify(current, null, 2));
  toast("JSON Copied");
};

document.getElementById("copyMdBtn").onclick = () => {
  const md = `## ${current.name} ${current.epithet}
**${current.ancestry} ${current.job}**
**Traits:** ${current.trait}

| Might | Agility | Wits | Spirit |
| :---: | :---: | :---: | :---: |
| ${current.stats.might} | ${current.stats.agility} | ${current.stats.wits} | ${current.stats.spirit} |

* **Virtue:** ${current.virtue}
* **Vice:** ${current.vice}
* **Hook:** ${current.hook}
* **Secret:** || ${current.secret} ||
`;
  navigator.clipboard.writeText(md);
  toast("Markdown Copied");
};

document.getElementById("importBtn").onclick = () => {
  try {
    const imported = JSON.parse(document.getElementById("importBox").value);
    current = imported;
    render();
    toast("Character Imported");
  } catch(e) { toast("Invalid JSON Data"); }
};

function deleteSave(i) {
  const deleted = saves[i];
  const deletedId = deleted ? deleted.id : null;
  saves.splice(i, 1);
  localStorage.setItem('lorebound_saves', JSON.stringify(saves));
  if (deletedId) {
    parties = parties.map(party => ({
      ...party,
      members: (party.members || []).filter(member => member.id !== deletedId)
    }));
    saveParties();
  }
  renderSaves();
  renderPartyPanel();
}

function loadSave(i) {
  const saved = saves[i];
  if (!saved) return;
  if (window.structuredClone) {
    current = window.structuredClone(saved);
  } else {
    current = JSON.parse(JSON.stringify(saved));
  }
  render();
  toast("Character Loaded");
}

document.getElementById("rerollBtn").onclick = () => generate('all');

document.getElementById("partySelect").onchange = (event) => {
  activePartyId = event.target.value || null;
  const party = parties.find(p => p.id === activePartyId);
  if (party) {
    document.getElementById("partyName").value = party.name || '';
    document.getElementById("partySetting").value = party.setting || '';
    document.getElementById("partyFactions").value = party.factions || '';
    document.getElementById("partyLocations").value = party.locations || '';
    document.getElementById("partyNotes").value = party.notes || '';
  }
  renderPartyMembers(party);
};

document.getElementById("newPartyBtn").onclick = () => {
  activePartyId = null;
  document.getElementById("partySelect").value = '';
  document.getElementById("partyName").value = '';
  document.getElementById("partySetting").value = '';
  document.getElementById("partyFactions").value = '';
  document.getElementById("partyLocations").value = '';
  document.getElementById("partyNotes").value = '';
  renderPartyMembers(null);
};

document.getElementById("savePartyBtn").onclick = () => {
  const name = document.getElementById("partyName").value.trim();
  const setting = document.getElementById("partySetting").value.trim();
  const factions = document.getElementById("partyFactions").value.trim();
  const locations = document.getElementById("partyLocations").value.trim();
  const notes = document.getElementById("partyNotes").value.trim();
  let party = parties.find(p => p.id === activePartyId);
  if (!party) {
    party = { id: makeId(), members: [] };
    parties.unshift(party);
    activePartyId = party.id;
  }
  party.name = name || party.name || 'Unnamed Party';
  party.setting = setting;
  party.factions = factions;
  party.locations = locations;
  party.notes = notes;
  saveParties();
  renderPartyPanel();
  toast("Party Saved");
};

document.getElementById("addToPartyBtn").onclick = () => {
  if (!activePartyId) {
    toast("Select or create a party first");
    return;
  }
  if (!current.id) {
    current.id = makeId();
    saves.unshift({ ...current, saveTitle: current.name });
    localStorage.setItem('lorebound_saves', JSON.stringify(saves));
    renderSaves();
  }
  const party = parties.find(p => p.id === activePartyId);
  if (!party) return;
  if (!party.members.find(member => member.id === current.id)) {
    party.members.push({ id: current.id, role: "Wild Card", relationship: "" });
    saveParties();
    renderPartyMembers(party);
    toast("Added to Party");
  } else {
    toast("Already in Party");
  }
};

document.getElementById("exportPartyMdBtn").onclick = () => {
  const party = parties.find(p => p.id === activePartyId);
  if (!party) {
    toast("Select a party first");
    return;
  }
  const members = party.members.map(member => {
    const character = saves.find(save => save.id === member.id);
    if (!character) return '';
    return `### ${character.name} ${character.epithet}
**${character.ancestry} ${character.job}**  
Role: ${member.role || 'Unassigned'}  
Relationship: ${member.relationship || '—'}

| Might | Agility | Wits | Spirit |
| :---: | :---: | :---: | :---: |
| ${character.stats.might} | ${character.stats.agility} | ${character.stats.wits} | ${character.stats.spirit} |

* Virtue: ${character.virtue}
* Vice: ${character.vice}
* Hook: ${character.hook}
`;
  }).filter(Boolean).join('\n');

  const md = `# ${party.name || 'Party'}
**Setting:** ${party.setting || '—'}  
**Factions:** ${party.factions || '—'}  
**Locations:** ${party.locations || '—'}  
**GM Notes:** ${party.notes || '—'}

## Roster
${members || '_No members yet._'}
`;
  navigator.clipboard.writeText(md);
  toast("Party Markdown Copied");
};

document.getElementById("exportPartyPdfBtn").onclick = () => {
  const party = parties.find(p => p.id === activePartyId);
  if (!party) {
    toast("Select a party first");
    return;
  }
  const members = party.members.map(member => {
    const character = saves.find(save => save.id === member.id);
    if (!character) return '';
    return `
      <section style="margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid #ccc;">
        <h3 style="margin:0 0 6px;">${character.name} ${character.epithet}</h3>
        <div><strong>${character.ancestry} ${character.job}</strong></div>
        <div>Role: ${member.role || 'Unassigned'} | Relationship: ${member.relationship || '—'}</div>
        <table style="width:100%; border-collapse: collapse; margin-top:8px;">
          <tr>
            <th style="border:1px solid #ddd; padding:6px;">Might</th>
            <th style="border:1px solid #ddd; padding:6px;">Agility</th>
            <th style="border:1px solid #ddd; padding:6px;">Wits</th>
            <th style="border:1px solid #ddd; padding:6px;">Spirit</th>
          </tr>
          <tr>
            <td style="border:1px solid #ddd; padding:6px; text-align:center;">${character.stats.might}</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:center;">${character.stats.agility}</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:center;">${character.stats.wits}</td>
            <td style="border:1px solid #ddd; padding:6px; text-align:center;">${character.stats.spirit}</td>
          </tr>
        </table>
        <ul style="margin:8px 0 0 16px;">
          <li><strong>Virtue:</strong> ${character.virtue}</li>
          <li><strong>Vice:</strong> ${character.vice}</li>
          <li><strong>Hook:</strong> ${character.hook}</li>
        </ul>
      </section>
    `;
  }).filter(Boolean).join('');
  const printable = `
    <html>
      <head>
        <title>${party.name || 'Party'} - Session Handout</title>
      </head>
      <body style="font-family: 'Inter', sans-serif; padding:24px;">
        <h1 style="margin-top:0;">${party.name || 'Party'}</h1>
        <p><strong>Setting:</strong> ${party.setting || '—'}</p>
        <p><strong>Factions:</strong> ${party.factions || '—'}</p>
        <p><strong>Locations:</strong> ${party.locations || '—'}</p>
        <p><strong>GM Notes:</strong> ${party.notes || '—'}</p>
        <h2>Roster</h2>
        ${members || '<p>No members yet.</p>'}
      </body>
    </html>
  `;
  const printWindow = window.open('', '_blank');
  if (printWindow) {
    printWindow.document.write(printable);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
  } else {
    console.warn("Popup blocked while trying to print party handout.");
    toast("Popup blocked. Printing in this tab instead.");
    document.body.innerHTML = printable;
    window.print();
  }
};

// Initial Launch
hydrateSaves();
renderPartyPanel();
generate();
</script>
</body>
</html>

